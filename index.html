<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>

<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
   integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
   crossorigin=""></script>

<script src="http://d3js.org/d3.v3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.1.4/highcharts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.1.4/js/modules/boost.js"></script>

<script src="./sqr.js"></script>
<script src="./stats/stats.js"></script>
<script src="./speclist.js"></script>

<style>
    #map { height: 400px; }
    #hists {
        width: 100%;
    }
    .hist {
        width: 100%;
        height: 160px;
    }
</style>

<div id="map"></div>
<div id="hists">Kliknutím do mapy vyberte čtverec.</div>

<script>
    var map = L.map('map').setView([49.7417517, 15.3350758], 7);
    map.scrollWheelZoom.disable();

    L.tileLayer('https://toolserver.org/tiles/hikebike/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
    }).addTo(map);

    var colScale = d3.scale.linear().domain([0.00005, 0.05]).interpolate(d3.interpolateHcl).range([d3.rgb('#fee0d2'), d3.rgb('#67000d')]);

    function getCol(v) {
        var share = stats[v.POLE] / stats.sum;
        return {
                'color': 'lightgray',
                'opacity': 1,
                'weight': 1,
                'fillColor': colScale(share),
                'fillOpacity': 0.5
        };
    };

    sqrs = sqrs.filter(function(v) {
        if (Object.keys(stats).indexOf(v.properties.POLE) > -1) {
            return true;
        } else {
            return false;
        }
    });

    var heatMap = L.geoJSON(sqrs, {
        style: function(f) {
            return getCol(f.properties)
        }
    }).addTo(map);

    function drawHist(id, vals) {
        var dv = document.createElement('div');
        dv.id = 'h' + id;
        dv.className = 'hist';
        document.getElementById('hists').appendChild(dv);

        Highcharts.chart('h' + id, {
            chart: {
                type: 'column'
            },
            boost: {
                enabled: true
            },
            credits: {
                enabled: false
            },
            title: {
                text: specList[id].Species
            },
            subtitle: {
                text: specList[id].SpeciesSci
            },
            xAxis: {
                categories: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ],
                crosshair: false
            },
            yAxis: {
                min: 0,
                max: 1,
                visible: false
            },
            tooltip: {
                followPointer: false,
                followTouchMove: false
            },
            plotOptions: {
                column: {
                    pointPadding: 0,
                    borderWidth: 0.1
                },
                series: {
                    enableMouseTracking: false
                }
            },
            series: [{
                animation: false,
                showInLegend: false,
                name: 'spc',
                data: vals

            }]
        });
    };

    heatMap.on('click', function(e) {
        fetch('./stats/' + e.sourceTarget.feature.properties.POLE + '.json')
        .then(function(resp) {
            resp.json().then(function(d) {
                document.getElementById('hists').innerHTML = '<h2>Čtverec č. ' 
                + e.sourceTarget.feature.properties.POLE + ' (' 
                + stats[e.sourceTarget.feature.properties.POLE]
                + ' listů)</h2>'
                Object.keys(d).forEach(function(k) {
                    if (k == 'wks') { return };
                    drawHist(k, d[k]);
                });
            });
        })
    });
</script>